{% extends "base.html" %}


{% block encabezado %}  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/informes.css') }}">
    <script src="{{ url_for('static', filename='scripts/panel_clasico.js') }}"></script>

{% endblock %}

{% block contenido %}
{% if tipo_usuario %}
        <script>
            tipo_usuario = '{{tipo_usuario}}'
        </script>
{% endif %}

<div class="box-general">
  <div class="box-estadisticas">
  <h1>Estadisticas</h1><button class="btn btn-secondary" onclick = "ver_estadisticas()">Ver</button>
  <div id="estadisticas" style="display: none;">
    <button class="btn btn-secondary" onclick="actualizar_grafico()">Actualizar</button>
    <div class="box-chart">
      <div class="chart">
          <canvas id="myChart" width="200" height="200"></canvas>
      </div>
      <div class="chart">
        <canvas id="myChart2" width="200" height="200"></canvas>
      </div>
    </div>
  </div>  
  </div>
    <div class="box-pendientes">
    <h1>Lista Pendientes</h1><button class="btn btn-secondary" onclick = "ver_pendientes()">Ver</button>

    <div id="pendientes" style="display: none;">
      <div class="box-fecha">
        <label for="fecha1">Desde:</label>
        <input class="input-fecha" type="date" value="{{fecha}}" id="fecha1">
        <label for="fecha2">Hasta:</label>
        <input class="input-fecha" type="date" value="{{fecha}}" id="fecha2">
        <button class="btn btn-secondary" onclick="visualizar_pendientes()">Visualizar</button>
      </div>
        <!-- The Modal -->
    <div class="modal" id="modal_info">
      <div class="modal-dialog">
          <div class="modal-content">

              <!-- Modal Header -->
              <div class="modal-header">
              </div>

              <!-- Modal body -->
              <div class="modal-body" id="info">
              </div>

              <!-- Modal footer -->
              <div class="modal-footer">
              </div>

          </div>
        </div>
      </div>
  
  <div id="mensaje">
  </div>
        <div class="container" id="body_panel">

        </div>

      </div>
    
      

    <script>
      var ventas = [0,0,0]
      var guias = [0,0,0]
      var respuesta = null
    </script>
    
<script>
    var ctx = document.getElementById('myChart');
    var ctx2 = document.getElementById('myChart2');
    let lista = []

    for(let i = 0 ; i < ventas.length ; i++ ){
      suma = ventas[i] + guias[i]
      lista.push(suma)
    }
    console.log(lista)
    const data = {
        labels: [
          'NO RETIRADO',
          'PARCIALIZADO',
          'RETIRADO'
        ],
        datasets: [{
          label: 'My First Dataset',
          data: lista ,
          backgroundColor: [
            'rgb(255, 99, 132)',
            'rgb(75, 192, 192)',
            'rgb(255, 205, 86)'
          ]
        }]
      };

    var chart = new Chart(ctx, {
      data: data,
      type: 'polarArea'
      });
    var chart2 = new Chart(ctx2, {
      data: data,
      type: 'pie'
      });

</script>

<script>
 
  function addData(chart, data, datasetIndex) {
    console.log('nuevos datos...')
    chart.data.datasets[datasetIndex].data = data;
    chart.update();
 }

  

  function actualizar_grafico() {
    console.log('ejecutando 1 vez')
    $.ajax({
      url: '/estadisticas/generales',
      type : 'post',
      success: function(resp) {
        console.log(resp)
        if(resp.estado){
          lista = []
          for(let i = 0 ; i < resp.ventas.length ; i++ ){
            suma = resp.ventas[i] + resp.guias[i]
            lista.push(suma)
          }
          console.log(lista)
          addData(chart,lista, 0)
          addData(chart2,lista, 0)
        }
        else{
          console.log('error')
        }
        // do something with the return value here if you like
      }
    });
    
  } 
  window.onload = actualizar_grafico()
  
  /*function visualizar_pendientes(){
    $('#badge-bol').empty()
    $('#badge-fact').empty()
    $('#badge-guia').empty()
    $('#box-boletas').empty()
    $('#box-facturas').empty()
    $('#box-guias').empty()
    inicio = $('#fecha1').val()
    fin = $('#fecha2').val()
    console.log('Buscando pendientes: ' + inicio.toString() + ' - hasta: ' + fin)
    $.ajax({
      url: '/estadisticas/pendientes/'+ inicio + '/' + fin,
      type : 'post',
      success: function(resp) {
        console.log(resp)
        if(resp){
         console.log('ahi respuesta')
         for(let i = 0; i<resp.length ; i++){

           console.log(i)
           x_lista = resp[i]
           if(i == 0){
             $('#badge-bol').append(x_lista.length.toString())
           }
           else if(i == 1){
            $('#badge-fact').append(x_lista.length.toString())
           }
           else if(i== 2){
            $('#badge-guia').append(x_lista.length.toString())
           }

           for(let j = 0; j < x_lista.length ;j ++ ){
             item = x_lista[j]

             if(i == 0){
              $('#box-boletas').append('<button>' + item.toString() +'</button>' )
             }
             else if(i == 1){
              $('#box-facturas').append('<button>' + item.toString() +'</button>' )
             }
             else if(i== 2){
              $('#box-guias').append('<button>' + item.toString() +'</button>' )
             }
           }
         }
         
        }
        else{
          console.log('error')
        }
        // do something with the return value here if you like
      }
    });
  }*/
  function visualizar_pendientes(){
    inicio = $('#fecha1').val()
    fin = $('#fecha2').val()
    console.log('Buscando pendientes: ' + inicio.toString() + ' - hasta: ' + fin)
    
    url = '/estadisticas/pendientes/'+ inicio + '/' + fin 
    $('#body_panel').load(url);
  }

  function ver_estadisticas(){
    var x = document.getElementById("estadisticas")
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
  }
  function ver_pendientes(){
    var x = document.getElementById("pendientes")
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
  }
  function cargar_body(x_fecha){
    console.log('documento actualizado')
    visualizar_pendientes()
}

</script>
{% endblock %}